<!DOCTYPE html>
<html>
  <head>
      <meta charset='utf-8' />
      <title>Jesuit Spirituality Centres</title>
      <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
      <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700' rel='stylesheet'>
      <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.2/mapbox-gl.js'></script>
      <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.2/mapbox-gl.css' rel='stylesheet' />
<link rel="stylesheet" type="text/css" href="scripts/style.css"/>

   </head>

  <body>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    
<div id='map' class='map'>
</div>

<div class='sidebar'>
    <div class='heading'>
    	<h1>Jesuit Spirituality Centres</h1>
    </div>
    <div id='listings' class='listings'>
    </div>
</div>

  <script>
  // This will let you use the .remove() function later on
  if (!('remove' in Element.prototype)) {
    Element.prototype.remove = function() {
      if (this.parentNode) {
          this.parentNode.removeChild(this);
      }
    };
  }

  mapboxgl.accessToken = 'pk.eyJ1IjoiZXhhbXBsZXMiLCJhIjoiY2lqbmpqazdlMDBsdnRva284cWd3bm11byJ9.V6Hg2oYJwMAxeoR9GEzkAA';

  // This adds the map
  var map = new mapboxgl.Map({
    // container id specified in the HTML
    container: 'map',
    // style URL
    style: 'mapbox://styles/mapbox/light-v9',
    // initial position in [long, lat] format
 center: [8.566015, 47.175605],
    // initial zoom
    zoom: 4,
    scrollZoom: true
  });
  
map.addControl(new mapboxgl.NavigationControl());


// Attempt to read in file
var stores = $.ajax({
          url:"https://gist.githubusercontent.com/piarasj/24693cafee0dc4fb81dfb8a6eff4d5b7/raw/7c0fa47d66a8acf867a600245f217caa5a326794/JesuitSpiritualityCentres.geojson",
          dataType: "json",
          success: console.log("County data successfully loaded."),
          error: function (xhr) {
            alert(xhr.statusText)
          }
        })
;



// d3.json("SpiritualityCentres.geojson", function(data) {
//    console.log(data);
//})
//;

// End attempt


map.on("load",function(e){map.addSource("places",{type:"geojson",data:stores}),buildLocationList(stores)}),stores.features.forEach(function(a,o){var e=document.createElement("div");e.id="marker-"+o,e.className="marker",new mapboxgl.Marker(e,{offset:[0,-23]}).setLngLat(a.geometry.coordinates).addTo(map),e.addEventListener("click",function(e){flyToStore(a),createPopUp(a);var t=document.getElementsByClassName("active");e.stopPropagation(),t[0]&&t[0].classList.remove("active"),document.getElementById("listing-"+o).classList.add("active")})});
function flyToStore(o){map.flyTo({center:o.geometry.coordinates,zoom:13})}

  function createPopUp(currentFeature) {
    var popUps = document.getElementsByClassName('mapboxgl-popup');
    if (popUps[0]) popUps[0].remove();


    var popup = new mapboxgl.Popup({closeOnClick: false})
          .setLngLat(currentFeature.geometry.coordinates)
//Popup elements
          .setHTML('<h3>' + currentFeature.properties.Centre + '</h3>' +
            '<h4>' + currentFeature.properties.Address + '</h4>')
          .addTo(map);
  }


  function buildLocationList(data) {
    for (i = 0; i < data.features.length; i++) {
      var currentFeature = data.features[i];
      var prop = currentFeature.properties;

      var listings = document.getElementById('listings');
      var listing = listings.appendChild(document.createElement('div'));
      listing.className = 'item';
      listing.id = "listing-" + i;
      var link = listing.appendChild(document.createElement('a'));
      link.href = '#';
      link.className = 'title';
      link.dataPosition = i;
      link.innerHTML = prop.Centre;

      var details = listing.appendChild(document.createElement('div'));
// Country CSS and name
      details.innerHTML = '<div class= "country">' +  prop.Country + '</div>';
//      if (prop.Centre) {
//        details.innerHTML += ' &middot; ' + prop.Address;
//      }


link.addEventListener("click",function(e){var t=data.features[this.dataPosition];flyToStore(t),createPopUp(t);var a=document.getElementsByClassName("active");a[0]&&a[0].classList.remove("active"),this.parentNode.classList.add("active")});}}
 

    </script>
  </body>
</html>
